<!doctype html><html lang=en><head><meta charset=utf-8><title>Authenticating to the Kubernetes API with client-go - Ghotfall's Corner</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.75.0"><meta itemprop=name content="Authenticating to the Kubernetes API with client-go"><meta itemprop=description content="You would learn how to authenticate to the Kubernetes API from an Golang application running inside or outside the Kubernetes cluster"><meta itemprop=datePublished content="2020-08-01T00:00:00+00:00"><meta itemprop=dateModified content="2020-08-01T00:00:00+00:00"><meta itemprop=wordCount content="470"><meta itemprop=image content="https://miro.medium.com/max/1190/1*NFv453pxVi1goLh-yVa4pQ.png"><meta itemprop=keywords content="go,golang,k8s,kubernetes,client-go,"><meta property="og:title" content="Authenticating to the Kubernetes API with client-go"><meta property="og:description" content="You would learn how to authenticate to the Kubernetes API from an Golang application running inside or outside the Kubernetes cluster"><meta property="og:type" content="article"><meta property="og:url" content="https://ghotfall.com/blog/2020/08/01/authenticating-to-the-kubernetes-api-with-client-go/"><meta property="og:image" content="https://miro.medium.com/max/1190/1*NFv453pxVi1goLh-yVa4pQ.png"><meta property="article:published_time" content="2020-08-01T00:00:00+00:00"><meta property="article:modified_time" content="2020-08-01T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://miro.medium.com/max/1190/1*NFv453pxVi1goLh-yVa4pQ.png"><meta name=twitter:title content="Authenticating to the Kubernetes API with client-go"><meta name=twitter:description content="You would learn how to authenticate to the Kubernetes API from an Golang application running inside or outside the Kubernetes cluster"><link rel=stylesheet href=/css/bundle.min.62ac49295840876f2ccff18a6df89ba9c9e743c15b876eedd73f358f94413f67.css integrity="sha256-YqxJKVhAh28sz/GKbfibqcnnQ8Fbh27t1z81j5RBP2c="><link rel=stylesheet href=/css/add-on.css></head><body><header id=site-header><nav id=site-nav><h1 class=nav-title><a href=/ class=nav>Blog</a></h1><menu id=site-nav-menu class="flyout-menu menu"><a href=/ class="nav link"><i class="fa fa-home"></i>Home</a>
<a href=/blog/ class="nav link"><i class="fa fa-th"></i>Blog</a>
<a href=/categories/ class="nav link"><i class="fa fa-bars"></i>Categories</a>
<a href=/about/ class="nav link"><i class="fa fa-user"></i>About</a>
<a href=/contact/ class="nav link"><i class="fa fa-paper-plane"></i>Contact</a>
<a href=#search-input class="nav search-toggle"><i class="fas fa-search">&nbsp;</i>Search</a></menu>
<a href=#search-input class="nav search-toggle"><i class="fas fa-search fa-2x">&nbsp;</i></a>
<a href=#site-nav class="nav nav-toggle"><i class="fas fa-bars fa-2x"></i></a></nav><menu id=search class=menu><input id=search-input class="search-input menu"></input><div id=search-results class="search-results menu"></div></menu></header><div id=wrapper><section id=site-intro class=hidden-single-column><a href=/><img src=https://ghotfall.com/img/main/logo.jpg class=message width=200px alt="Ghotfall's corner"></a><header><h1>Ghotfall's Corner</h1></header><main><p>Here you can find a lot of interesting stories about life, work, hobbies and even more!</p></main><footer><ul class=socnet-icons><li><a href=//github.com/ghotfall target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//gitlab.com/ghotfall target=_blank rel=noopener title=GitLab class="fab fa-gitlab"></a></li><li><a href=//facebook.com/100004706048519 target=_blank rel=noopener title=Facebook class="fab fa-facebook"></a></li><li><a href=//reddit.com/user/ghotfall target=_blank rel=noopener title=Reddit class="fab fa-reddit"></a></li><li><a href=//instagram.com/ghotfall target=_blank rel=noopener title=Instagram class="fab fa-instagram"></a></li><li><a href=//pinterest.com/ghotfall target=_blank rel=noopener title=Pinterest class="fab fa-pinterest-p"></a></li><li><a href=//telegram.me/ghotfall target=_blank rel=noopener title=telegram class="fab fa-telegram"></a></li></ul></footer></section><main id=site-main><article class=post><header><div class=title><h2><a href=/blog/2020/08/01/authenticating-to-the-kubernetes-api-with-client-go/>Authenticating to the Kubernetes API with client-go</a></h2><p>You would learn how to authenticate to the Kubernetes API from an Golang application running inside or outside the Kubernetes cluster</p></div><div class=meta><time class=published datetime="2020-08-01 00:00:00 +0000 UTC">August 1, 2020</time>
<span class=author>Ghotfall</span><p>3 minute read</p></div></header><section id=socnet-share><a href="//twitter.com/share?text=Authenticating%20to%20the%20Kubernetes%20API%20with%20client-go&url=https%3a%2f%2fghotfall.com%2fblog%2f2020%2f08%2f01%2fauthenticating-to-the-kubernetes-api-with-client-go%2f" target=_blank rel=noopener class="nav share-btn twitter"><i class="fab fa-twitter"></i><p>&nbsp;Twitter</p></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fghotfall.com%2fblog%2f2020%2f08%2f01%2fauthenticating-to-the-kubernetes-api-with-client-go%2f" target=_blank rel=noopener class="nav share-btn facebook"><i class="fab fa-facebook"></i><p>&nbsp;Facebook</p></a><a href="//www.reddit.com/submit?url=https%3a%2f%2fghotfall.com%2fblog%2f2020%2f08%2f01%2fauthenticating-to-the-kubernetes-api-with-client-go%2f&title=Authenticating%20to%20the%20Kubernetes%20API%20with%20client-go" target=_blank rel=noopener class="nav share-btn reddit"><i class="fab fa-reddit-alien"></i><p>&nbsp;Reddit</p></a><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fghotfall.com%2fblog%2f2020%2f08%2f01%2fauthenticating-to-the-kubernetes-api-with-client-go%2f&title=Authenticating%20to%20the%20Kubernetes%20API%20with%20client-go" target=_blank rel=noopener class="nav share-btn linkedin"><i class="fab fa-linkedin"></i><p>&nbsp;LinkedIn</p></a><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fghotfall.com%2fblog%2f2020%2f08%2f01%2fauthenticating-to-the-kubernetes-api-with-client-go%2f&description=Authenticating%20to%20the%20Kubernetes%20API%20with%20client-go" target=_blank rel=noopener class="nav share-btn pinterest"><i class="fab fa-pinterest-p"></i><p>&nbsp;Pinterest</p></a><a href="mailto:?subject=Check%20out%20this%20post%20by Ghotfall&body=https%3a%2f%2fghotfall.com%2fblog%2f2020%2f08%2f01%2fauthenticating-to-the-kubernetes-api-with-client-go%2f" target=_blank class="nav share-btn email" data-proofer-ignore><i class="fas fa-envelope"></i><p>&nbsp;Email</p></a></section><a href=/blog/2020/08/01/authenticating-to-the-kubernetes-api-with-client-go/ class="image featured"><img src=https://miro.medium.com/max/1190/1*NFv453pxVi1goLh-yVa4pQ.png alt></a><div class=content><p>Client-go, go library for talking to a kubernetes cluster, provides few ways for authenticating to the Kubernetes API. Possible steps are quite different for apps which are running inside and outside the cluster.</p><p>Your actions would be quite simple if you planning to pack your golang app in container and use it within pod. Let&rsquo;s look at the example:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>config</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rest</span>.<span style=color:#a6e22e>InClusterConfig</span>()
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
	panic(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>()) <span style=color:#75715e>// oops, something went wrong, you can&#39;t make calls to k8s API :(
</span><span style=color:#75715e></span>}
</code></pre></div><p>But keep in mind that this approach uses the <strong>Service Account token</strong>.</p><p>Service accounts are usually associated with pods running in the cluster through the ServiceAccount Admission Controller. Bearer tokens are mounted into pods at well-known locations, and allow in-cluster processes to talk to the API server.</p><p>So, client-go would try to find mounted token at the <strong>/var/run/secrets/kubernetes.io/serviceaccount</strong> path. In addition, you will need to tweak your Service Account, if you want to perform some opperations within pod and have <strong>RBAC enabled</strong>. So prepare RBAC Role or ClusterRole and binding for it before deploying your app to the cluster.</p><p>For working outside of the cluster you can try whis way:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>kubeconfig</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>clientcmd</span>.<span style=color:#a6e22e>NewNonInteractiveDeferredLoadingClientConfig</span>(
    <span style=color:#a6e22e>clientcmd</span>.<span style=color:#a6e22e>NewDefaultClientConfigLoadingRules</span>(),
    <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>clientcmd</span>.<span style=color:#a6e22e>ConfigOverrides</span>{},
)

<span style=color:#a6e22e>config</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kubeconfig</span>.<span style=color:#a6e22e>ClientConfig</span>()
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
	panic(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>()) <span style=color:#75715e>// oops, something went wrong, you can&#39;t make calls to k8s API :(
</span><span style=color:#75715e></span>}
</code></pre></div><p>This will work if you have kubeconfig file already in place.</p><p>Do you want more flexible approach? Try this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>configPath</span> = <span style=color:#e6db74>&#34;&#34;</span>

<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>LookupEnv</span>(<span style=color:#e6db74>&#34;KUBECONFIG&#34;</span>); <span style=color:#a6e22e>ok</span> {
    <span style=color:#a6e22e>configPath</span> = <span style=color:#a6e22e>value</span>
} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span><span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stat</span>(<span style=color:#e6db74>&#34;~/.kube/config&#34;</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
	<span style=color:#a6e22e>configPath</span> = <span style=color:#e6db74>&#34;~/.kube/config&#34;</span>
}

<span style=color:#a6e22e>config</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>clientcmd</span>.<span style=color:#a6e22e>BuildConfigFromFlags</span>(<span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>configPath</span>)
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
	panic(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>()) <span style=color:#75715e>// oops, something went wrong, you can&#39;t make calls to k8s API :(
</span><span style=color:#75715e></span>}
</code></pre></div><p>This code snippet will firstly try to get path to kubeconfig from environment variable. If it fails, it will try to find file by default path. This kubeconfig will be used for talking to your cluster.</p><p>But you can see that I didn&rsquo;t add another else branch with panic() after file searching, so configPath variable will be empty if kubeconfig is missing. Under the hood <strong>clientcmd.BuildConfigFromFlags</strong> function will try to use &ldquo;in-cluster&rdquo; method, if you pass empty string to it as arguments.</p><p>So you can treat this variant as hybrid method.</p><p>After obtaining config you can finnaly make calls to the Kubernetes API:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>clientSet</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>NewForConfig</span>(<span style=color:#a6e22e>config</span>)
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
	panic(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>()) <span style=color:#75715e>// ugh, something wrong again &gt;_&lt;
</span><span style=color:#75715e></span>}

<span style=color:#75715e>// Simple example from client-go repository: get info about all pods
</span><span style=color:#75715e>// in cluster with one simple list request
</span><span style=color:#75715e></span><span style=color:#a6e22e>pods</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>clientSet</span>.<span style=color:#a6e22e>CoreV1</span>().<span style=color:#a6e22e>Pods</span>(<span style=color:#e6db74>&#34;&#34;</span>).<span style=color:#a6e22e>List</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>TODO</span>(), <span style=color:#a6e22e>metav1</span>.<span style=color:#a6e22e>ListOptions</span>{})
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
	panic(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>()) <span style=color:#75715e>// your request failed 
</span><span style=color:#75715e></span>}
<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;There are %d pods in the cluster\n&#34;</span>, len(<span style=color:#a6e22e>pods</span>.<span style=color:#a6e22e>Items</span>))
</code></pre></div><p>I hope the article was useful to you. Come here more often.</p></div><footer><ul class=stats><li class=categories><ul><li><a class=article-terms-link href=/categories/programming/>Programming</a></li><li><a class=article-terms-link href=/categories/devops/>DevOps</a></li><li><a class=article-terms-link href=/categories/golang/>Golang</a></li></ul></li><li class=tags><ul><li><a class=article-terms-link href=/tags/go/>go</a></li><li><a class=article-terms-link href=/tags/golang/>golang</a></li><li><a class=article-terms-link href=/tags/k8s/>k8s</a></li><li><a class=article-terms-link href=/tags/kubernetes/>kubernetes</a></li><li><a class=article-terms-link href=/tags/client-go/>client-go</a></li></ul></li></ul></footer></article><article class=post><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"ghotfall-com"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article><div class=pagination><a href=/blog/2020/08/02/morning-drawing-1/ class=button><div class=next><div>Morning Drawing 1</div></div></a></div></main><section id=site-sidebar><section id=recent-posts><header><h1>Recent posts</h1></header><article class=mini-post><section><a href=/blog/2020/08/02/morning-drawing-1/ class="image featured"><img src=https://ghotfall.com/img/content/2020/08/02/preview.jpeg alt></a></section><header><h2><a href=/blog/2020/08/02/morning-drawing-1/>Morning Drawing 1</a></h2><time class=published datetime>August 2, 2020</time></header></article><article class=mini-post><section><a href=/blog/2020/08/01/authenticating-to-the-kubernetes-api-with-client-go/ class="image featured"><img src=https://miro.medium.com/max/1190/1*NFv453pxVi1goLh-yVa4pQ.png alt></a></section><header><h2><a href=/blog/2020/08/01/authenticating-to-the-kubernetes-api-with-client-go/>Authenticating to the Kubernetes API with client-go</a></h2><time class=published datetime>August 1, 2020</time></header></article></section><section id=categories><header><h1><a href=/categories>Categories</a></h1></header><ul><li><a href=/categories/life/>life<span class=count>2</span></a><li><a href=/categories/devops/>devops<span class=count>1</span></a><li><a href=/categories/drawing/>drawing<span class=count>1</span></a><li><a href=/categories/golang/>golang<span class=count>1</span></a><li><a href=/categories/programming/>programming<span class=count>1</span></a></li></ul></section><section id=mini-bio><header><h1>About</h1></header><p>Learn more about Andrii "Ghotfall" Myrhorodskyi</p><footer><a href=/about class=button>Learn More</a></footer></section></section><footer id=site-footer><ul class=socnet-icons><li><a href=//github.com/ghotfall target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//gitlab.com/ghotfall target=_blank rel=noopener title=GitLab class="fab fa-gitlab"></a></li><li><a href=//facebook.com/100004706048519 target=_blank rel=noopener title=Facebook class="fab fa-facebook"></a></li><li><a href=//reddit.com/user/ghotfall target=_blank rel=noopener title=Reddit class="fab fa-reddit"></a></li><li><a href=//instagram.com/ghotfall target=_blank rel=noopener title=Instagram class="fab fa-instagram"></a></li><li><a href=//pinterest.com/ghotfall target=_blank rel=noopener title=Pinterest class="fab fa-pinterest-p"></a></li><li><a href=//telegram.me/ghotfall target=_blank rel=noopener title=telegram class="fab fa-telegram"></a></li></ul><p class=copyright>&copy; 2020
Ghotfall's Corner
.<br>Theme: <a href=https://github.com/pacollins/hugo-future-imperfect-slim target=_blank rel=noopener>Hugo Future Imperfect Slim</a><br>A <a href=https://html5up.net/future-imperfect target=_blank rel=noopener>HTML5 UP port</a> | Powered by <a href=https://gohugo.io/ title=0.75.0 target=_blank rel=noopener>Hugo</a></p></footer><a id=back-to-top href=# class="fas fa-arrow-up fa-2x"></a><script src=/js/highlight.js></script><script>hljs.initHighlightingOnLoad();</script><script src=/js/bundle.min.6b070c99ff1c783896a89c6e282bed602c4fbe50a21cdfc2bed54af5c0245bfb.js integrity="sha256-awcMmf8ceDiWqJxuKCvtYCxPvlCiHN/CvtVK9cAkW/s="></script><script src=/js/add-on.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-173554069-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>